name: å‘å¸ƒåˆ° npm

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: è¿è¡Œæµ‹è¯•
      run: |
        python -c "
        import sys
        required_modules = ['fastmcp', 'playwright']
        missing = []
        for module in required_modules:
            try:
                __import__(module)
            except ImportError:
                missing.append(module)
        if missing:
            print(f'âŒ ç¼ºå°‘ä¾èµ–: {missing}')
            sys.exit(1)
        print('âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡')
        "
        
    - name: æ›´æ–°ç‰ˆæœ¬å·
      if: github.event_name == 'workflow_dispatch'
      run: |
        npm version ${{ github.event.inputs.version }} --no-git-tag-version
        
    - name: åˆ›å»º .npmignore
      run: |
        cat > .npmignore << EOF
        # å¼€å‘æ–‡ä»¶
        test_*.py
        debug_*.py
        *.pyc
        __pycache__/
        .pytest_cache/
        .coverage
        
        # Git æ–‡ä»¶
        .git/
        .gitignore
        .github/
        
        # IDE æ–‡ä»¶
        .vscode/
        .idea/
        *.swp
        *.swo
        
        # æ—¥å¿—æ–‡ä»¶
        *.log
        logs/
        
        # ä¸´æ—¶æ–‡ä»¶
        tmp/
        temp/
        .tmp/
        
        # æµè§ˆå™¨æ•°æ®
        browser_data/
        .deps_installed
        
        # çŽ¯å¢ƒæ–‡ä»¶
        .env
        .env.local
        
        # æ–‡æ¡£æºæ–‡ä»¶
        docs/
        DEPLOYMENT_GUIDE.md
        
        # Python è™šæ‹ŸçŽ¯å¢ƒ
        venv/
        .venv/
        EOF
        
    - name: ç¡®ä¿å¯åŠ¨è„šæœ¬å¯æ‰§è¡Œ
      run: chmod +x dist/index.js
      
    - name: å‘å¸ƒåˆ° npm
      run: npm publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        
    - name: åˆ›å»º GitHub Release
      if: github.event_name == 'push'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          ### å®‰è£…æ–¹å¼
          ```bash
          npm install -g xiaohongshu-mcp-server
          ```
          
          ### åœ¨ CherryStudio ä¸­é…ç½®
          ```json
          {
            "name": "å°çº¢ä¹¦",
            "command": "xiaohongshu-mcp",
            "args": []
          }
          ```
          
          ### æ›´æ–°æ—¥å¿—
          - ä¼˜åŒ–äº†è¯„è®ºå‘å¸ƒæ€§èƒ½
          - ä¿®å¤äº†å·²çŸ¥é—®é¢˜
          - æ”¹è¿›äº†ç”¨æˆ·ä½“éªŒ
          
          æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ï¼šhttps://www.npmjs.com/package/xiaohongshu-mcp-server
        draft: false
        prerelease: false
